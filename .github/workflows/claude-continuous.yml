name: Claude Continuous Work

on:
  schedule:
    # Run every 2 hours during work hours (UTC)
    - cron: '0 */2 * * *'
  workflow_dispatch:
    inputs:
      max_issues:
        description: 'Maximum number of issues to process'
        required: false
        default: '3'

concurrency:
  group: claude-continuous
  cancel-in-progress: false

jobs:
  find-work:
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.find.outputs.issues }}
      has_work: ${{ steps.find.outputs.has_work }}
    steps:
      - name: Find open Claude issues
        id: find
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          MAX_ISSUES="${{ github.event.inputs.max_issues || '3' }}"

          # Find open issues with 'claude' label that don't have linked PRs
          ISSUES=$(gh issue list \
            --repo ${{ github.repository }} \
            --label "claude" \
            --state open \
            --limit "$MAX_ISSUES" \
            --json number,title,labels,updatedAt \
            --jq '[.[] | select(.labels | map(.name) | any(. == "in-progress" or . == "blocked") | not)] | .[0:'"$MAX_ISSUES"']')

          echo "Found issues: $ISSUES"

          # Check if any issues found
          ISSUE_COUNT=$(echo "$ISSUES" | jq 'length')

          if [ "$ISSUE_COUNT" -gt 0 ]; then
            echo "has_work=true" >> $GITHUB_OUTPUT
            echo "issues=$ISSUES" >> $GITHUB_OUTPUT
            echo "âœ… Found $ISSUE_COUNT issue(s) to work on"
          else
            echo "has_work=false" >> $GITHUB_OUTPUT
            echo "issues=[]" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No open claude-labeled issues found"
          fi

  process-issue:
    needs: find-work
    if: needs.find-work.outputs.has_work == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write
      issues: write
      pull-requests: write
      actions: read
      id-token: write
    strategy:
      matrix:
        issue: ${{ fromJson(needs.find-work.outputs.issues) }}
      max-parallel: 1  # Process one issue at a time
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if issue already has PR
        id: check-pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ matrix.issue.number }}"

          # Check for linked PRs
          PR_COUNT=$(gh pr list \
            --repo ${{ github.repository }} \
            --search "closes #$ISSUE_NUM OR fixes #$ISSUE_NUM OR resolves #$ISSUE_NUM" \
            --json number \
            --jq 'length')

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUM already has PR, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Issue #$ISSUE_NUM ready for work"
          fi

      - name: Mark issue as in-progress
        if: steps.check-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ matrix.issue.number }}"
          gh issue edit "$ISSUE_NUM" --add-label "in-progress"
          gh issue comment "$ISSUE_NUM" --body "ðŸ¤– Claude is now working on this issue automatically."

      - name: Determine complexity and model
        id: complexity
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          MODEL="claude-sonnet-4-5"

          # Check labels for complexity
          LABELS='${{ toJson(matrix.issue.labels.*.name) }}'

          if echo "$LABELS" | grep -qE "complex|architecture|refactor|performance"; then
            MODEL="claude-opus-4-6"
            echo "ðŸ” Complex issue detected, using Opus"
          elif echo "$LABELS" | grep -qE "bug|hotfix|simple|documentation"; then
            MODEL="claude-sonnet-4-5"
            echo "âš¡ Simple issue detected, using Sonnet"
          else
            # Check issue body length
            ISSUE_BODY='${{ matrix.issue.title }} ${{ matrix.issue.body }}'
            BODY_LENGTH=$(echo "$ISSUE_BODY" | wc -c)

            if [ "$BODY_LENGTH" -gt 1000 ]; then
              MODEL="claude-opus-4-6"
              echo "ðŸ“Š Long issue description, using Opus"
            else
              MODEL="claude-sonnet-4-5"
              echo "ðŸ“Š Standard issue, using Sonnet"
            fi
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT

      - name: Setup Claude Code and Git
        if: steps.check-pr.outputs.skip != 'true'
        run: |
          # Install Claude Code v2.1.34+ (works, unlike action's bundled v2.1.31)
          echo "ðŸ“¦ Installing Claude Code..."
          npm install -g @anthropic-ai/claude-code
          claude --version

          # Configure git for commits
          git config user.name "claude[bot]"
          git config user.email "claude[bot]@users.noreply.github.com"

      - name: Work on issue with Claude CLI
        id: claude
        if: steps.check-pr.outputs.skip != 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ matrix.issue.number }}"
          ISSUE_TITLE="${{ matrix.issue.title }}"
          MODEL="${{ steps.complexity.outputs.model }}"
          MAX_TURNS="${{ steps.complexity.outputs.model == 'claude-opus-4-6' && '150' || '100' }}"

          # Create prompt file
          cat > /tmp/claude-prompt.txt << 'PROMPT_EOF'
# Continuous Work Mode - Issue #${ISSUE_NUM}

You are working in **continuous automation mode** on this issue. Your goal is to:
1. **Understand** the issue completely
2. **Implement** a complete solution
3. **Test** your implementation
4. **Create a PR** when done

## Issue Details
- **Issue**: #${ISSUE_NUM}
- **Title**: ${ISSUE_TITLE}
- **Repository**: ${{ github.repository }}
- **Model**: ${MODEL}

## Work Instructions

### Step 1: Analyze
- Read the issue description with: gh issue view ${ISSUE_NUM}
- Check CLAUDE.md and docs/ for guidelines
- Identify all requirements

### Step 2: Implement
- Write clean, tested code
- Follow project patterns
- Ensure tests pass

### Step 3: Deliver
- Commit with clean message (imperative, <72 chars, NO co-author)
- Create PR: gh pr create --title "..." --body "Closes #${ISSUE_NUM}"

## Important
- Use gh CLI for issue/PR operations
- If blocked: gh issue edit ${ISSUE_NUM} --add-label "blocked" + comment
- If need info: gh issue edit ${ISSUE_NUM} --add-label "needs-info" + comment
- Check CLAUDE.md, .claude/, docs/ for project guidelines

Begin working systematically.
PROMPT_EOF

          # Run Claude Code CLI directly (avoids broken action v1)
          echo "ðŸ¤– Running Claude Code v2.1.34+ (bypassing broken action)..."
          claude --model "$MODEL" \
            --max-turns "$MAX_TURNS" \
            --timeout 1800000 \
            < /tmp/claude-prompt.txt || {
            echo "âš ï¸ Claude Code failed, check logs"
            exit 1
          }

      - name: Check completion status
        if: always() && steps.check-pr.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUM="${{ matrix.issue.number }}"

          # Check if PR was created
          PR_COUNT=$(gh pr list \
            --repo ${{ github.repository }} \
            --search "closes #$ISSUE_NUM OR fixes #$ISSUE_NUM OR resolves #$ISSUE_NUM" \
            --json number \
            --jq 'length')

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "âœ… PR created successfully for issue #$ISSUE_NUM"
            gh issue edit "$ISSUE_NUM" --remove-label "in-progress"
          else
            echo "âš ï¸ No PR created yet for issue #$ISSUE_NUM"

            # Check if blocked or needs info
            LABELS=$(gh issue view "$ISSUE_NUM" --json labels --jq '.labels[].name')

            if echo "$LABELS" | grep -qE "blocked|needs-info"; then
              echo "â„¹ï¸ Issue is blocked or needs more information"
              gh issue edit "$ISSUE_NUM" --remove-label "in-progress"
            else
              # Keep in-progress label for retry
              gh issue comment "$ISSUE_NUM" --body "âš ï¸ Work in progress. Claude will continue in the next scheduled run."
            fi
          fi

  summary:
    needs: [find-work, process-issue]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report summary
        run: |
          if [ "${{ needs.find-work.outputs.has_work }}" == "true" ]; then
            echo "âœ… Continuous work cycle completed"
            echo "Issues processed: $(echo '${{ needs.find-work.outputs.issues }}' | jq 'length')"
          else
            echo "â„¹ï¸ No work to do - all claude-labeled issues are complete or blocked"
          fi
